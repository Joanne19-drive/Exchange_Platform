{%extends "foreign/foreign_base.html"%}
{%block contents%}
<div style="width:750px;">
    <div class="d-flex justify-content-between ">
        <div class="d-flex align-items-center ">
            <h1>{{univ.away_name}}</h1>
            <span>파견교 후기 공유</span>
            <a href="{% url "country:country_wiki" univ.country.pk%}"><h3>{{univ.country}}</h3></a>
        </div>
</div>
<hr>
<p>작성자:{{review.post_author.nickname}}</p>
<p>제목: {{review.title}}</p>
<p>파견학기: {{review.away_year}}-{{review.away_semester}}</p>
<p>날짜: {{review.created_at}}</p>
<p>내용:
     
    {% if review.image %}
    <div><img src="{{review.image.url}}" style="width:700px"/></div>
    {% endif %}
    {{review.content}}</p>
{% if IsReviewAuthor %}
<form action="{% url "foreign:review_delete" univ.pk review.pk %}" method="post" class="ReviewDeleteForm" style="  display: inline; background: transparent">
    {% csrf_token %}
    <button onclick="return confirm('정말 삭제하시겠습니까?')" type="submit" >삭제</button>
</form>
<a href="{% url "foreign:review_update" univ.pk review.pk%}">수정</a>
{% endif %}
<a href="{% url "foreign:review_list" univ.pk %}">목록</a>
<hr>
<p>댓글</p>
<div class="post_{{review.id}} post">
{%if all_comment %}
{%for comment in all_comment %}
<div class="comment_{{comment.id}} d-flex justify-content-between">
    {{comment.comment_author.nickname}} &#160; &#160; 
    {{comment.comment_content}}
    {% if request.user == comment.comment_author %}
    <div>
    <button class="btn btn-outline-secondary update " onclick="EditComment({{comment.id}} ,'{{comment.comment_content}}')">수정</button>
    <button class="btn btn-outline-secondary delete " onclick="onClickDelete({{comment.id}} )">삭제</button>
    </div>
    {%endif%}
</div>
{%endfor%}
{%endif%}
</div>

<form action="./comment_create/" method="POST">
    {% csrf_token %}
    <input type="text" name="comment_content" id="comment_{{review.id}}" placeholder='댓글달기...' style="width: 80%;"/>
    <div class="btn btn-outline-dark submit" onclick="onClickComment('{{user.is_authenticated}}',{{review.id}}, document.querySelector('#comment_{{review.id}}').value)">
        submit
    </div>
</form>
</div>

<script>
        const onClickComment= async(is_authenticated,post_id, comment_content) => {  
        console.log(is_authenticated)
            if (is_authenticated == 'False') {
                alert('로그인이 필요한 서비스입니다.');
                window.location.href='{% url "login:login" %}';
        }else{
        const url = './comment_create/';
        const res= await fetch(url,{        
            method: 'POST',
            headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify({is_authenticated:is_authenticated,post_id:post_id,comment_content:comment_content})
        }); 
    
        const {post_id:id,comment_content:content,comment_id:c_id}= await res.json();        
        commentHandleResponse(id,content,c_id);
    }
    };

    const commentHandleResponse=(post_id,comment_content,comment_id) => {
        const element=document.querySelector(`.post_${post_id}`)
        const newDiv = document.createElement('div')
        newDiv.className = `comment_${comment_id} d-flex justify-content-between`;
        newDiv.innerHTML = `
        {{request.user.nickname}} &#160; &#160; ${comment_content}
        <div>
        <button class="btn btn-outline-secondary update " onclick="EditComment(${comment_id} ,'${comment_content}')">수정</button>
        <div class="btn btn-outline-secondary delete" onclick="onClickDelete(${comment_id})">삭제</div>
        </div>`
        element.appendChild(newDiv)
        //댓글 입력창 비워주기
        const input_content = document.querySelector(`#comment_${post_id}`)
        input_content.value = null
    }
    
    //댓글 수정
    const EditComment = (comment_id,comment_content)=>{
        const element = document.querySelector(`.comment_${comment_id}`);
        element.innerHTML = ` 
            <input type="text" id="edit_comment" value=${comment_content} class="w-75"/>
            <button class="btn btn-sm btn-outline-dark" onclick="onClickUpdate('${comment_id}', document.querySelector('#edit_comment').value)">수정</button>
            `

    }
    const onClickUpdate= async(comment_id,comment_content) => { 
        const allowance =  confirm('수정하시겠습니까?'); 
        if (allowance == true) {
        const url = './comment_update/';
        const res= await fetch(url,{        
            method: 'POST',
            headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify({comment_id:comment_id, comment_content:comment_content})
        }); 
        const {comment_id:id, comment_content:content, nickname:nickname} = await res.json();        
        UpdateHandleResponse(id,content,nickname);
    };
    };

    const UpdateHandleResponse = (comment_id,comment_content,nickname)=>{
        const element = document.querySelector(`.comment_${comment_id}`)
        element.innerHTML = `
        ${nickname} &#160; &#160; 
        ${comment_content}
        <div>
        <button class="btn btn-outline-secondary update " onclick="EditComment(${comment_id} ,'${comment_content}')">수정</button>
        <button class="btn btn-outline-secondary delete " onclick="onClickDelete(${comment_id} )">삭제</button>
        </div>
        `
    }


    //댓글 삭제
    const onClickDelete= async(comment_id) => { 
        const allowance =  confirm('정말로 삭제하시겠습니까?'); 
        if (allowance == true) {
        const url = './comment_delete/';
        const res= await fetch(url,{        
            method: 'POST',
            headers:{
            'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: JSON.stringify({comment_id:comment_id})
        }); 
        const {comment_id:id} = await res.json();       
        deleteHandleResponse(id);
    };
    };

    const deleteHandleResponse = (comment_id)=>{
    
        const element = document.querySelector(`.comment_${comment_id}`)
        const element_comment = element.closest('.post')
        console.log(element_comment)
        element_comment.removeChild(element)
    }

</script>
{%endblock%}